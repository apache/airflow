..  Licensed to the Apache Software Foundation (ASF) under one
    or more contributor license agreements.  See the NOTICE file
    distributed with this work for additional information
    regarding copyright ownership.  The ASF licenses this file
    to you under the Apache License, Version 2.0 (the
    "License"); you may not use this file except in compliance
    with the License.  You may obtain a copy of the License at

..    http://www.apache.org/licenses/LICENSE-2.0

..  Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, either express or implied.  See the License for the
    specific language governing permissions and limitations
    under the License.

Google Cloud Vision Operators
=============================

.. contents::
  :depth: 1
  :local:

.. _howto/operator:CloudVisionProductSetCreateOperator:

CloudVisionProductSetCreateOperator
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Creates a new :code:`ProductSet` resource.

For parameter definition, take a look at
:class:`~airflow.contrib.operators.gcp_vision_operator.CloudVisionProductSetCreateOperator`

Arguments
"""""""""

Some arguments in the example DAG are taken from the OS environment variables:

.. literalinclude:: ../../../../airflow/contrib/example_dags/example_gcp_vision.py
    :language: python
    :start-after: [START howto_operator_vision_args_common]
    :end-before: [END howto_operator_vision_args_common]

.. literalinclude:: ../../../../airflow/contrib/example_dags/example_gcp_vision.py
    :language: python
    :start-after: [START howto_operator_vision_productset_explicit_id]
    :end-before: [END howto_operator_vision_productset_explicit_id]

Using the operator
""""""""""""""""""

We are using the ``ProductSet`` and ``Retry`` objects from Google libraries:

.. literalinclude:: ../../../../airflow/contrib/example_dags/example_gcp_vision.py
    :language: python
    :start-after: [START howto_operator_vision_productset_import]
    :end-before: [END howto_operator_vision_productset_import]

.. literalinclude:: ../../../../airflow/contrib/example_dags/example_gcp_vision.py
    :language: python
    :start-after: [START howto_operator_vision_retry_import]
    :end-before: [END howto_operator_vision_retry_import]

.. literalinclude:: ../../../../airflow/contrib/example_dags/example_gcp_vision.py
    :language: python
    :start-after: [START howto_operator_vision_productset]
    :end-before: [END howto_operator_vision_productset]

The ``product_set_id`` argument can be omitted (it will be generated by the API):

.. literalinclude:: ../../../../airflow/contrib/example_dags/example_gcp_vision.py
    :language: python
    :dedent: 4
    :start-after: [START howto_operator_vision_product_set_create]
    :end-before: [END howto_operator_vision_product_set_create]

Or it can be specified explicitly:

.. literalinclude:: ../../../../airflow/contrib/example_dags/example_gcp_vision.py
    :language: python
    :dedent: 4
    :start-after: [START howto_operator_vision_product_set_create_2]
    :end-before: [END howto_operator_vision_product_set_create_2]


Templating
""""""""""

.. literalinclude:: ../../../../airflow/contrib/operators/gcp_vision_operator.py
    :language: python
    :dedent: 4
    :start-after: [START vision_productset_create_template_fields]
    :end-before: [END vision_productset_create_template_fields]

More information
""""""""""""""""

See `Google Cloud Vision ProductSet create documentation
<https://googleapis.github.io/google-cloud-python/latest/vision/gapic/v1/api.html#google.cloud.vision_v1.ProductSearchClient.create_product_set>`_.

.. _howto/operator:CloudVisionProductSetGetOperator:

CloudVisionProductSetGetOperator
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Gets information associated with a :code:`ProductSet`.

For parameter definition, take a look at
:class:`~airflow.contrib.operators.gcp_vision_operator.CloudVisionProductSetGetOperator`

Arguments
"""""""""

Some arguments in the example DAG are taken from the OS environment variables:

.. literalinclude:: ../../../../airflow/contrib/example_dags/example_gcp_vision.py
    :language: python
    :start-after: [START howto_operator_vision_args_common]
    :end-before: [END howto_operator_vision_args_common]

.. literalinclude:: ../../../../airflow/contrib/example_dags/example_gcp_vision.py
    :language: python
    :start-after: [START howto_operator_vision_productset_explicit_id]
    :end-before: [END howto_operator_vision_productset_explicit_id]

Using the operator
""""""""""""""""""

If ``product_set_id`` was generated by the API it can be extracted from XCOM:

.. literalinclude:: ../../../../airflow/contrib/example_dags/example_gcp_vision.py
    :language: python
    :dedent: 4
    :start-after: [START howto_operator_vision_product_set_get]
    :end-before: [END howto_operator_vision_product_set_get]

Otherwise it can be specified explicitly:

.. literalinclude:: ../../../../airflow/contrib/example_dags/example_gcp_vision.py
    :language: python
    :dedent: 4
    :start-after: [START howto_operator_vision_product_set_get_2]
    :end-before: [END howto_operator_vision_product_set_get_2]

Templating
""""""""""

.. literalinclude:: ../../../../airflow/contrib/operators/gcp_vision_operator.py
    :language: python
    :dedent: 4
    :start-after: [START vision_productset_get_template_fields]
    :end-before: [END vision_productset_get_template_fields]

More information
""""""""""""""""

See `Google Cloud Vision ProductSet get documentation
<https://googleapis.github.io/google-cloud-python/latest/vision/gapic/v1/api.html#google.cloud.vision_v1.ProductSearchClient.get_product_set>`_.

.. _howto/operator:CloudVisionProductSetUpdateOperator:

CloudVisionProductSetUpdateOperator
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Makes changes to a :code:`ProductSet` resource. Only :code:`display_name` can be updated
currently.

.. note:: To locate the `ProductSet` resource, its `name` in the form
  ``projects/PROJECT_ID/locations/LOC_ID/productSets/PRODUCT_SET_ID`` is necessary.

You can provide the `name` directly as an attribute of the `product_set` object.
However, you can leave it blank and provide `location` and `product_set_id` instead (and
optionally `project_id` - if not present, the connection default will be used) and the
`name` will be created by the operator itself.

This mechanism exists for your convenience, to allow leaving the `project_id` empty and
having Airflow use the connection default `project_id`.

For parameter definition, take a look at
:class:`~airflow.contrib.operators.gcp_vision_operator.CloudVisionProductSetUpdateOperator`

Arguments
"""""""""

Some arguments in the example DAG are taken from the OS environment variables:

.. literalinclude:: ../../../../airflow/contrib/example_dags/example_gcp_vision.py
    :language: python
    :start-after: [START howto_operator_vision_args_common]
    :end-before: [END howto_operator_vision_args_common]

.. literalinclude:: ../../../../airflow/contrib/example_dags/example_gcp_vision.py
    :language: python
    :start-after: [START howto_operator_vision_productset_explicit_id]
    :end-before: [END howto_operator_vision_productset_explicit_id]

Using the operator
""""""""""""""""""

We are using the ``ProductSet`` object from the Google Cloud Vision library:

.. literalinclude:: ../../../../airflow/contrib/example_dags/example_gcp_vision.py
    :language: python
    :start-after: [START howto_operator_vision_productset_import]
    :end-before: [END howto_operator_vision_productset_import]

.. literalinclude:: ../../../../airflow/contrib/example_dags/example_gcp_vision.py
    :language: python
    :start-after: [START howto_operator_vision_productset]
    :end-before: [END howto_operator_vision_productset]

Initialization of the task:

If ``product_set_id`` was generated by the API it can be extracted from XCOM:

.. literalinclude:: ../../../../airflow/contrib/example_dags/example_gcp_vision.py
    :language: python
    :dedent: 4
    :start-after: [START howto_operator_vision_product_set_update]
    :end-before: [END howto_operator_vision_product_set_update]

Otherwise it can be specified explicitly:

.. literalinclude:: ../../../../airflow/contrib/example_dags/example_gcp_vision.py
    :language: python
    :dedent: 4
    :start-after: [START howto_operator_vision_product_set_update_2]
    :end-before: [END howto_operator_vision_product_set_update_2]

Templating
""""""""""

.. literalinclude:: ../../../../airflow/contrib/operators/gcp_vision_operator.py
    :language: python
    :dedent: 4
    :start-after: [START vision_productset_update_template_fields]
    :end-before: [END vision_productset_update_template_fields]

More information
""""""""""""""""

See `Google Cloud Vision ProductSet update documentation
<https://googleapis.github.io/google-cloud-python/latest/vision/gapic/v1/api.html#google.cloud.vision_v1.ProductSearchClient.update_product_set>`_.

.. _howto/operator:CloudVisionProductSetDeleteOperator:

CloudVisionProductSetDeleteOperator
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Permanently deletes a :code:`ProductSet`. :code:`Products` and :code:`ReferenceImages` in
the :code:`ProductSet` are not deleted. The actual image files are not deleted from
Google Cloud Storage.

For parameter definition, take a look at
:class:`~airflow.contrib.operators.gcp_vision_operator.CloudVisionProductSetDeleteOperator`

Arguments
"""""""""

Some arguments in the example DAG are taken from the OS environment variables:

.. literalinclude:: ../../../../airflow/contrib/example_dags/example_gcp_vision.py
    :language: python
    :start-after: [START howto_operator_vision_args_common]
    :end-before: [END howto_operator_vision_args_common]

.. literalinclude:: ../../../../airflow/contrib/example_dags/example_gcp_vision.py
    :language: python
    :start-after: [START howto_operator_vision_productset_explicit_id]
    :end-before: [END howto_operator_vision_productset_explicit_id]

Using the operator
""""""""""""""""""

If ``product_set_id`` was generated by the API it can be extracted from XCOM:

.. literalinclude:: ../../../../airflow/contrib/example_dags/example_gcp_vision.py
    :language: python
    :dedent: 4
    :start-after: [START howto_operator_vision_product_set_delete]
    :end-before: [END howto_operator_vision_product_set_delete]

Otherwise it can be specified explicitly:

.. literalinclude:: ../../../../airflow/contrib/example_dags/example_gcp_vision.py
    :language: python
    :dedent: 4
    :start-after: [START howto_operator_vision_product_set_delete_2]
    :end-before: [END howto_operator_vision_product_set_delete_2]

Templating
""""""""""

.. literalinclude:: ../../../../airflow/contrib/operators/gcp_vision_operator.py
    :language: python
    :dedent: 4
    :start-after: [START vision_productset_delete_template_fields]
    :end-before: [END vision_productset_delete_template_fields]

More information
""""""""""""""""

See `Google Cloud Vision ProductSet delete documentation
<https://googleapis.github.io/google-cloud-python/latest/vision/gapic/v1/api.html#google.cloud.vision_v1.ProductSearchClient.delete_product_set>`_.

.. _howto/operator:CloudVisionProductCreateOperator:

CloudVisionProductCreateOperator
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Creates and returns a new product resource.

Possible errors regarding the :code:`Product` object provided:

- Returns INVALID_ARGUMENT if `display_name` is missing or longer than 4096 characters.
- Returns INVALID_ARGUMENT if `description` is longer than 4096 characters.
- Returns INVALID_ARGUMENT if `product_category` is missing or invalid.

For parameter definition, take a look at
:class:`~airflow.contrib.operators.gcp_vision_operator.CloudVisionProductCreateOperator`

Arguments
"""""""""

Some arguments in the example DAG are taken from the OS environment variables:

.. literalinclude:: ../../../../airflow/contrib/example_dags/example_gcp_vision.py
    :language: python
    :start-after: [START howto_operator_vision_args_common]
    :end-before: [END howto_operator_vision_args_common]

.. literalinclude:: ../../../../airflow/contrib/example_dags/example_gcp_vision.py
    :language: python
    :start-after: [START howto_operator_vision_product_explicit_id]
    :end-before: [END howto_operator_vision_product_explicit_id]

Using the operator
""""""""""""""""""

We are using the ``Product`` and ``Retry`` objects from Google libraries:

.. literalinclude:: ../../../../airflow/contrib/example_dags/example_gcp_vision.py
    :language: python
    :start-after: [START howto_operator_vision_product_import]
    :end-before: [END howto_operator_vision_product_import]

.. literalinclude:: ../../../../airflow/contrib/example_dags/example_gcp_vision.py
    :language: python
    :start-after: [START howto_operator_vision_retry_import]
    :end-before: [END howto_operator_vision_retry_import]

.. literalinclude:: ../../../../airflow/contrib/example_dags/example_gcp_vision.py
    :language: python
    :start-after: [START howto_operator_vision_product]
    :end-before: [END howto_operator_vision_product]

The ``product_id`` argument can be omitted (it will be generated by the API):

.. literalinclude:: ../../../../airflow/contrib/example_dags/example_gcp_vision.py
    :language: python
    :dedent: 4
    :start-after: [START howto_operator_vision_product_create]
    :end-before: [END howto_operator_vision_product_create]

Or it can be specified explicitly:

.. literalinclude:: ../../../../airflow/contrib/example_dags/example_gcp_vision.py
    :language: python
    :dedent: 4
    :start-after: [START howto_operator_vision_product_create_2]
    :end-before: [END howto_operator_vision_product_create_2]


Templating
""""""""""

.. literalinclude:: ../../../../airflow/contrib/operators/gcp_vision_operator.py
    :language: python
    :dedent: 4
    :start-after: [START vision_product_create_template_fields]
    :end-before: [END vision_product_create_template_fields]

More information
""""""""""""""""

See `Google Cloud Vision Product create documentation
<https://googleapis.github.io/google-cloud-python/latest/vision/gapic/v1/api.html#google.cloud.vision_v1.ProductSearchClient.create_product>`_.

.. _howto/operator:CloudVisionProductGetOperator:

CloudVisionProductGetOperator
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Gets information associated with a :code:`Product`.

Possible errors:

- Returns NOT_FOUND if the `Product` does not exist.

For parameter definition, take a look at
:class:`~airflow.contrib.operators.gcp_vision_operator.CloudVisionProductGetOperator`

Arguments
"""""""""

Some arguments in the example DAG are taken from the OS environment variables:

.. literalinclude:: ../../../../airflow/contrib/example_dags/example_gcp_vision.py
    :language: python
    :start-after: [START howto_operator_vision_args_common]
    :end-before: [END howto_operator_vision_args_common]

.. literalinclude:: ../../../../airflow/contrib/example_dags/example_gcp_vision.py
    :language: python
    :start-after: [START howto_operator_vision_product_explicit_id]
    :end-before: [END howto_operator_vision_product_explicit_id]

Using the operator
""""""""""""""""""

If ``product_id`` was generated by the API it can be extracted from XCOM:

.. literalinclude:: ../../../../airflow/contrib/example_dags/example_gcp_vision.py
    :language: python
    :dedent: 4
    :start-after: [START howto_operator_vision_product_get]
    :end-before: [END howto_operator_vision_product_get]

Otherwise it can be specified explicitly:

.. literalinclude:: ../../../../airflow/contrib/example_dags/example_gcp_vision.py
    :language: python
    :dedent: 4
    :start-after: [START howto_operator_vision_product_get_2]
    :end-before: [END howto_operator_vision_product_get_2]

Templating
""""""""""

.. literalinclude:: ../../../../airflow/contrib/operators/gcp_vision_operator.py
    :language: python
    :dedent: 4
    :start-after: [START vision_product_get_template_fields]
    :end-before: [END vision_product_get_template_fields]

More information
""""""""""""""""

See `Google Cloud Vision Product get documentation
<https://googleapis.github.io/google-cloud-python/latest/vision/gapic/v1/api.html#google.cloud.vision_v1.ProductSearchClient.get_product>`_.

.. _howto/operator:CloudVisionProductUpdateOperator:

CloudVisionProductUpdateOperator
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Makes changes to a :code:`Product` resource. Only the :code:`display_name`,
:code:`description`, and :code:`labels` fields can be updated right now.
If labels are updated, the change will not be reflected in queries until the next index
time.

.. note:: To locate the `Product` resource, its `name` in the form
  ``projects/PROJECT_ID/locations/LOC_ID/products/PRODUCT_ID`` is necessary.

You can provide the `name` directly as an attribute of the `product` object. However, you
can leave it blank and provide `location` and `product_id` instead (and optionally
`project_id` - if not present, the connection default will be used) and the `name` will
be created by the operator itself.

This mechanism exists for your convenience, to allow leaving the `project_id` empty and
having Airflow use the connection default `project_id`.

Possible errors:

- Returns NOT_FOUND if the `Product` does not exist.
- Returns INVALID_ARGUMENT if `display_name` is present in `update_mask` but is missing
  from the request or longer than 4096 characters.
- Returns INVALID_ARGUMENT if `description` is present in `update_mask` but is longer than
  4096 characters.
- Returns INVALID_ARGUMENT if `product_category` is present in `update_mask`.

For parameter definition, take a look at
:class:`~airflow.contrib.operators.gcp_vision_operator.CloudVisionProductUpdateOperator`

Arguments
"""""""""

Some arguments in the example DAG are taken from the OS environment variables:

.. literalinclude:: ../../../../airflow/contrib/example_dags/example_gcp_vision.py
    :language: python
    :start-after: [START howto_operator_vision_args_common]
    :end-before: [END howto_operator_vision_args_common]

.. literalinclude:: ../../../../airflow/contrib/example_dags/example_gcp_vision.py
    :language: python
    :start-after: [START howto_operator_vision_product_explicit_id]
    :end-before: [END howto_operator_vision_product_explicit_id]

Using the operator
""""""""""""""""""

We are using the ``Product`` object from the Google Cloud Vision library:

.. literalinclude:: ../../../../airflow/contrib/example_dags/example_gcp_vision.py
    :language: python
    :start-after: [START howto_operator_vision_product_import]
    :end-before: [END howto_operator_vision_product_import]

.. literalinclude:: ../../../../airflow/contrib/example_dags/example_gcp_vision.py
    :language: python
    :start-after: [START howto_operator_vision_product]
    :end-before: [END howto_operator_vision_product]

If ``product_id`` was generated by the API it can be extracted from XCOM:

.. literalinclude:: ../../../../airflow/contrib/example_dags/example_gcp_vision.py
    :language: python
    :dedent: 4
    :start-after: [START howto_operator_vision_product_update]
    :end-before: [END howto_operator_vision_product_update]

Otherwise it can be specified explicitly:

.. literalinclude:: ../../../../airflow/contrib/example_dags/example_gcp_vision.py
    :language: python
    :dedent: 4
    :start-after: [START howto_operator_vision_product_update_2]
    :end-before: [END howto_operator_vision_product_update_2]

Templating
""""""""""

.. literalinclude:: ../../../../airflow/contrib/operators/gcp_vision_operator.py
    :language: python
    :dedent: 4
    :start-after: [START vision_product_update_template_fields]
    :end-before: [END vision_product_update_template_fields]

More information
""""""""""""""""

See `Google Cloud Vision Product update documentation
<https://googleapis.github.io/google-cloud-python/latest/vision/gapic/v1/api.html#google.cloud.vision_v1.ProductSearchClient.update_product>`_.

.. _howto/operator:CloudVisionProductDeleteOperator:

CloudVisionProductDeleteOperator
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Permanently deletes a product and its reference images.

Metadata of the product and all its images will be deleted right away, but search queries
against :code:`ProductSets` containing the product may still work until all related
caches are refreshed.

Possible errors:

- Returns NOT_FOUND if the product does not exist.

For parameter definition, take a look at
:class:`~airflow.contrib.operators.gcp_vision_operator.CloudVisionProductDeleteOperator`

Arguments
"""""""""

Some arguments in the example DAG are taken from the OS environment variables:

.. literalinclude:: ../../../../airflow/contrib/example_dags/example_gcp_vision.py
    :language: python
    :start-after: [START howto_operator_vision_args_common]
    :end-before: [END howto_operator_vision_args_common]

.. literalinclude:: ../../../../airflow/contrib/example_dags/example_gcp_vision.py
    :language: python
    :start-after: [START howto_operator_vision_product_explicit_id]
    :end-before: [END howto_operator_vision_product_explicit_id]

Using the operator
""""""""""""""""""

If ``product_id`` was generated by the API it can be extracted from XCOM:

.. literalinclude:: ../../../../airflow/contrib/example_dags/example_gcp_vision.py
    :language: python
    :dedent: 4
    :start-after: [START howto_operator_vision_product_delete]
    :end-before: [END howto_operator_vision_product_delete]

Otherwise it can be specified explicitly:

.. literalinclude:: ../../../../airflow/contrib/example_dags/example_gcp_vision.py
    :language: python
    :dedent: 4
    :start-after: [START howto_operator_vision_product_delete_2]
    :end-before: [END howto_operator_vision_product_delete_2]

Templating
""""""""""

.. literalinclude:: ../../../../airflow/contrib/operators/gcp_vision_operator.py
    :language: python
    :dedent: 4
    :start-after: [START vision_product_delete_template_fields]
    :end-before: [END vision_product_delete_template_fields]

More information
""""""""""""""""

See `Google Cloud Vision Product delete documentation
<https://googleapis.github.io/google-cloud-python/latest/vision/gapic/v1/api.html#google.cloud.vision_v1.ProductSearchClient.delete_product>`_.
