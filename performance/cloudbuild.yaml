# Copyright 2020 Google Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
#
# This software is provided as-is,
# without warranty or representation for any use or purpose.
# Your use of it is subject to your agreement with Google.
---
steps:
  - name: 'gcr.io/cloud-builders/gsutil'
    id: 'restore-cache'
    entrypoint: "/bin/bash"
    args: ["./scripts/cache/restore_cache.sh"]
    env:
      - 'HOME=/root'
    volumes:
      - name: 'cache-tmp-dir'
        path: /cache
      - name: 'pre-commit-cache-dir'
        path: /root/.cache

  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-ci-image'
    entrypoint: '/bin/bash'
    env:
      - 'PROJECT_ID=$PROJECT_ID'
    args: ['./scripts/ci-image/build_and_push.sh']
    waitFor: ['-']

  - name: 'gcr.io/$PROJECT_ID/airflow-gepard-ci-build-image'
    id: 'precommit-run'
    entrypoint: '/bin/bash'
    args: ['./scripts/run_precommit.sh']
    env:
      - 'HEAD_REPO_URL=$_HEAD_REPO_URL'
      - 'HEAD_BRANCH=$_HEAD_BRANCH'
      - 'COMMIT_SHA=$COMMIT_SHA'
      - 'HOME=/root'
    waitFor:
      - 'build-ci-image'
      - 'restore-cache'
    volumes:
      - name: 'cache-tmp-dir'
        path: /cache
      - name: 'pre-commit-cache-dir'
        path: /root/.cache

  - name: 'gcr.io/cloud-builders/gsutil'
    id: 'store-cache'
    entrypoint: "/bin/bash"
    args: ["scripts/cache/store_cache.sh"]
    waitFor: ['precommit-run']
    env:
      - 'HOME=/root'
    volumes:
      - name: 'cache-tmp-dir'
        path: /cache
      - name: 'pre-commit-cache-dir'
        path: /root/.cache

timeout: 2400s
