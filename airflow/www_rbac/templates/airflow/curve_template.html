{% extends 'appbuilder/init.html' %}
{% import 'appbuilder/baselib.html' as baselib %}


{% block head_css %}
{{ super() }}
<link rel="stylesheet" type="text/css"
      href="{{ url_for('static', filename='css/curve_template.css') }}">
<link rel="stylesheet" type="text/css"
      href="{{ url_for('static', filename='css/main.css') }}">
<link rel="stylesheet" type="text/css"
      href="{{ url_for('static', filename='css/bootstrap-treeview.min.css') }}">
<script src="{{ url_for('static', filename='js/echarts.js') }}" type="text/javascript"></script>
{% endblock %}

{% block body %}
<div id="root">
  <div id="result-container" class="card">
    <table id="result_table">
      <thead>
      <tr class="result-content-row">
        <th>Key</th>
        <th>Value</th>
      </tr>
      </thead>
      <tbody id="result_detail"></tbody>
    </table>
  </div>

  <div id="echarts-container" style="flex:1" class="card flex-column">
    <div class="flex" id="actions-container">
        <span class="btn-group" data-toggle="buttons">
          <label class="btn active" for="update-chart-w-m" id="update-chart-w-m-label"
                 title="Also include past task instances when clearing this one">
            <input id="update-chart-w-m" type="radio" name="chart-type" checked autocomplete="off">
            角度/扭矩
          </label>
          <label class="btn" for="update-chart-t-m" id="update-chart-t-m-label"
                 title="Also include past task instances when clearing this one">
            <input id="update-chart-t-m" type="radio" name="chart-type" autocomplete="off">
            时间/扭矩
          </label>
          <label class="btn" for="update-chart-t-w" id="update-chart-t-w-label"
                 title="Also include past task instances when clearing this one">
            <input id="update-chart-t-w" type="radio" name="chart-type" autocomplete="off">
            时间/角度
          </label>
        </span>
      <!--        <button class="btn btn-primary margin" id="update-chart-w-m">角度/扭矩</button>-->
      <!--        <button class="btn btn-primary margin" id="update-chart-t-m">时间/扭矩</button>-->
      <!--        <button class="btn btn-primary margin" id="update-chart-t-w">时间/角度</button>-->
    </div>
    <div style="flex:1">
      <div id="echarts-main" style="width: 100%;height:100%;"></div>
    </div>
  </div>
  <div id="curve-template-list-container" class="card">
    <h4>曲线模板簇</h4>
    <div id="tree"></div>
  </div>
</div>
{% endblock %}


{% block tail_js %}
{{ super() }}
<script src="{{ url_for('static', filename='js/bootstrap-treeview.min.js') }}" type="text/javascript"></script>
<script type="text/javascript">
  let curveChart = null;
  const curves = [];
  const modes = [];
  const tree = [];
  let currentMode = null;
  const colors = {};
  const curveTemplate = JSON.parse('{{ curve_template|tojson|safe }}');
  const timeStep = curveTemplate.curve_param.sampling_time;
  const curKeyMap = {
    'cur_w': '角度',
    'cur_m': '扭矩',
    'cur_t': '时间',
  };
  const treeRoles = {
    cluster: 'cluster',
    group: 'group',
    curve: 'curve',
  };

  const chartParams = {
    xKey: 'cur_w',
    yKey: 'cur_m',
    xName: curKeyMap.cur_w,
    yName: curKeyMap.cur_m,
  };

  function setChartParams(xKey, yKey) {
    chartParams.xKey = xKey;
    chartParams.yKey = yKey;
    chartParams.xName = curKeyMap[xKey];
    chartParams.yName = curKeyMap[yKey];
  }

  // todo: 在左侧增加曲线列表
  // fixme: 在一张图上只显示一个模板簇

  console.log(curveTemplate);

  function randomColor() {
    return '#' + (function (color) {
      return (color += '0123456789abcdef'[Math.floor(Math.random() * 16)])
      && (color.length === 6) ? color : arguments.callee(color);
    })('');
  }

  function genColors() {
    const modes = Object.keys(curveTemplate.template_cluster);
    modes.forEach((m) => {
      colors[m] = randomColor();
    });
  }


  function isEmptyValue(val) {
    return val === undefined || val === null || val === '';
  }

  const treeItemClickActions = {
    cluster: (event, data) => {
      currentMode = data.mode;
      updateChart();
    },
    group: (event, data) => {
      currentMode = data.mode;
      updateChart();
    },
    curve: (event, data) => {
      currentMode = data.mode;
      updateChart();
    },
  };

  function renderTemplateList() {
    $('#tree').treeview({ data: tree }).on('nodeSelected', (event, data) => {
      console.log(event, data);
      treeItemClickActions[data.role](event, data);
    });
  }


  function renderParamTableRow(key, value) {
    const $tr = $('<tr class="result-content-row">');
    const $key = $(`<td class="result-content-item">${key}</td>`);
    let content = value;
    if (typeof value === 'object') {
      content = JSON.stringify(value);
    }
    const $value = $(`<td class="result-content-item">${isEmptyValue(content) ? '' : content}</td>`);
    $tr.append([$key, $value]);
    return $tr;
  }

  function renderCurveParam() {
    const { curve_param: curveParam } = curveTemplate;
    const $rows = [];
    Object.entries(curveParam).forEach(([k, v]) => {
      $rows.push(renderParamTableRow(k, v));
    });
    $('#result_detail').append($rows);
  }

  function genTimeSeries(step, length) {
    const digits = (`${step}`).split('.')[1];
    return Array.from(new Array(length), (item, idx) => +(idx * step).toFixed(digits ? digits.length : 4));
  }

  function loadCurvesData() {
    const { template_cluster: templateCluster } = curveTemplate;
    Object.entries(templateCluster).forEach(([mode, cluster]) => {
      modes.push(mode);
      const row = {
        text: `模板簇-${mode}`,
        nodes: [],
        role: treeRoles.cluster,
        mode
      };
      const { curve_template_group_array: templateGroup } = cluster;
      templateGroup.forEach((group, groupIdx) => {
        const { template_data_array: curvesData, template_centroid_index: centroid } = group;
        const gRow = {
          text: `曲线聚类-${mode}-${centroid}`,
          nodes: [],
          mode,
          role: treeRoles.group,
        };
        curvesData.forEach((curve, idx) => {
          const { template_angle: cur_w, template_torque: cur_m, start_point } = curve;
          curves.push({
            start_point,
            mode,
            centroid,
            cur_w,
            cur_m,
            cur_t: genTimeSeries(timeStep, cur_w.length),
          });
          gRow.nodes.push({
            text: `曲线-${mode}-${centroid}-${idx}`,
            role: treeRoles.curve,
            mode,
          });
        });
        row.nodes.push(gRow);
      });
      tree.push(row);
    });
    currentMode = modes[0];
  }

  function genData(curve, xKey, yKey) {
    if (!curve || !curve[xKey] || !curve[yKey]) {
      return [];
    }
    const xData = curve[xKey];
    const yData = curve[yKey];
    return xData.map((x, idx) => [xData[idx], yData[idx]]);
  }

  function genDataSeries() {
    const { xKey, yKey, yName } = chartParams;
    return curves.filter(c => c.mode === currentMode).map(c => ({
      name: yName,
      type: 'line',
      data: genData(c, xKey, yKey),
      symbol: 'none',
      lineStyle: {
        color: colors[c.mode],
      },
      markLine: {
        data: [
          { type: 'min', name: '最小值' },
          { type: 'max', name: '最大值' },
        ],
      },
    }));
  }

  function updateChart() {
    const { xName, yName } = chartParams;
    const option = {
      title: {
        text: `${xName}-${yName}图`,
      },
      legend: {
        type: 'scroll',
        data: [yName],
      },
      xAxis: { type: 'value' },
      yAxis: { type: 'value' },
      series: genDataSeries(),
      dataZoom: [
        {
          type: 'slider',
          xAxisIndex: 0,
          filterMode: 'empty',
        },
        {
          type: 'slider',
          yAxisIndex: 0,
          filterMode: 'empty',
        },
        {
          type: 'inside',
          xAxisIndex: 0,
          filterMode: 'empty',
        },
        {
          type: 'inside',
          yAxisIndex: 0,
          filterMode: 'empty',
        },
      ],
      tooltip: {
        trigger: 'axis',
      },
    };
    curveChart.setOption(option);
  }

  function chartInit() {
    curveChart = echarts.init(document.getElementById('echarts-main'));

    // 指定图表的配置项和数据
    const option = {};

    // 使用刚指定的配置项和数据显示图表。
    curveChart.setOption(option);
    setChartParams('cur_w', 'cur_m');
    updateChart();
  }

  $('#update-chart-w-m').change(() => {
    setChartParams('cur_w', 'cur_m');
    updateChart();
  });

  $('#update-chart-t-m').change(() => {
    setChartParams('cur_t', 'cur_m');
    updateChart();
  });

  $('#update-chart-t-w').change(() => {
    setChartParams('cur_t', 'cur_w');
    updateChart();
  });

  $(window).resize(() => {
    if (!curveChart) {
      return;
    }
    curveChart.resize();
  });

  $(document).ready(() => {
    chartInit();
    renderCurveParam();
    genColors();
    loadCurvesData();

    renderTemplateList();
    console.log(curves);
    chartInit();
  });
</script>
{% endblock %}
